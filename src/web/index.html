<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' data:; connect-src 'self' https://cdn.jsdelivr.net;"
    />
    <title>AI BRAINSTORMING | æˆ°ç•¥å¤§è…¦æœƒè­°å®¤</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ§ </text></svg>"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&family=Noto+Sans+TC:wght@300;400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-color: #020202;
        --glass-bg: rgba(15, 15, 15, 0.8);
        --accent-color: #00f2ff;
        --accent-purple: #a855f7; /* Softer, more premium lavender purple */
        --accent-orange: #fbbf24;
        --text-main: #f8fafc;
        --text-dim: #94a3b8;
        --card-border: rgba(255, 255, 255, 0.08);
        --inner-glow: inset 0 0 20px rgba(0, 242, 255, 0.03);
        
        /* Layered Shadows for Depth */
        --card-shadow: 
          0 4px 6px -1px rgba(0, 0, 0, 0.5),
          0 10px 15px -3px rgba(0, 0, 0, 0.8),
          0 20px 25px -5px rgba(0, 0, 0, 0.9);

        /* Fluid Typography System */
        --font-tiny: clamp(0.7rem, 0.2vw + 0.65rem, 0.8rem);
        --font-small: clamp(0.8rem, 0.3vw + 0.75rem, 0.9rem);
        --font-base: clamp(0.9rem, 0.4vw + 0.85rem, 1.05rem);
        --font-h2: clamp(1.1rem, 0.5vw + 1rem, 1.3rem);
        --font-h1: clamp(1.6rem, 3vw + 1.2rem, 3rem);
        
        /* Spacing System */
        --gap-main: clamp(15px, 2vw + 15px, 35px);
        --container-pad: clamp(20px, 5vw, 60px);
      }

      /* Custom Scrollbar - Premium Minimalist */
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.05); border-radius: 10px; }
      ::-webkit-scrollbar-thumb:hover { background: var(--accent-color); }

      body {
        background-color: var(--bg-color);
        background-image: 
          radial-gradient(circle at 50% -20%, rgba(0, 242, 255, 0.05) 0%, transparent 60%),
          radial-gradient(circle at -10% 50%, rgba(168, 85, 247, 0.03) 0%, transparent 40%);
        color: var(--text-main);
        font-family: 'Inter', 'Noto Sans TC', sans-serif;
        margin: 0;
        padding: var(--container-pad);
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        -webkit-font-smoothing: antialiased;
      }

      .header {
        width: 100%;
        max-width: 1240px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 50px;
      }

      h1 {
        font-family: 'Orbitron', sans-serif;
        letter-spacing: -1px;
        color: var(--text-main);
        background: linear-gradient(to right, #fff, var(--accent-color));
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin: 0;
        font-size: var(--font-h1);
        font-weight: 700;
        filter: drop-shadow(0 0 10px rgba(0, 242, 255, 0.2));
      }

      .card {
        background: var(--glass-bg);
        backdrop-filter: blur(30px) saturate(180%);
        border: 1px solid var(--card-border);
        border-radius: 28px;
        padding: var(--gap-main);
        box-shadow: var(--card-shadow);
        box-sizing: border-box;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: visible;
        min-width: 0;
      }
      
      .card::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; height: 1px;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      }

      .card:hover {
        border-color: rgba(255, 255, 255, 0.15);
        transform: translateY(-2px);
      }

      /* Active AI Pulse Animation */
      @keyframes pulse-cyan {
        0% { box-shadow: 0 0 0 0 rgba(0, 242, 255, 0.15); }
        70% { box-shadow: 0 0 0 15px rgba(0, 242, 255, 0); }
        100% { box-shadow: 0 0 0 0 rgba(0, 242, 255, 0); }
      }
      
      .thinking-active {
        animation: pulse-cyan 2s infinite;
        border-color: var(--accent-color) !important;
      }

      .card-accent {
        border: 1px solid rgba(0, 242, 255, 0.2) !important;
        box-shadow: inset 0 0 30px rgba(0, 242, 255, 0.02), var(--card-shadow);
      }

      .card-purple {
        border: 1px solid rgba(168, 85, 247, 0.2) !important;
        box-shadow: inset 0 0 30px rgba(168, 85, 247, 0.02), var(--card-shadow);
      }

      input, textarea, select {
        background: rgba(13, 13, 13, 0.8);
        border: 1px solid rgba(255,255,255,0.08);
        color: var(--text-main);
        padding: 14px 18px;
        border-radius: 14px;
        font-size: var(--font-small);
        transition: all 0.2s ease;
        outline: none;
      }

      optgroup {
        background: #111;
        color: var(--accent-purple);
        font-weight: 600;
        font-size: 0.9rem;
      }

      option {
        background: #0a0a0a;
        color: var(--text-main);
        padding: 10px;
      }

      input:focus, textarea:focus, select:focus {
        background: #000;
        border-color: var(--accent-color);
        box-shadow: 0 0 0 4px rgba(0, 242, 255, 0.08);
      }

      .label-text {
        display: block;
        font-size: var(--font-tiny);
        color: var(--text-dim);
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 1.2px;
        font-weight: 600;
      }

      h2 {
        font-size: var(--font-h2);
        color: var(--text-main);
        margin-top: 0;
        margin-bottom: 24px;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        font-family: 'Orbitron', sans-serif;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      h2::before {
        content: '';
        display: inline-block;
        width: 3px;
        height: 16px;
        background: var(--accent-color);
        border-radius: 2px;
      }

      .dashboard-container {
        width: 100%;
        max-width: 1240px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--gap-main);
        margin: 20px auto;
        box-sizing: border-box;
        align-items: start;
      }

      .card-full { grid-column: span 2; }
      .grid-half { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
        gap: 35px; 
      }

      .guide-btn {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: var(--text-dim);
        padding: 10px 22px;
        border-radius: 100px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: all 0.3s;
        font-family: 'Orbitron', sans-serif;
        font-weight: 500;
      }

      .guide-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border-color: white;
      }

      .trigger-btn {
        background: #fff;
        color: #000;
        border: none;
        padding: 12px 28px;
        border-radius: 100px;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 700;
        transition: all 0.3s cubic-bezier(0.19, 1, 0.22, 1);
        font-family: 'Orbitron', sans-serif;
        margin-left: 15px;
        box-shadow: 0 10px 20px rgba(255, 255, 255, 0.1);
      }

      .trigger-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 30px rgba(0, 242, 255, 0.3);
        background: var(--accent-color);
      }

      .trigger-btn:active { transform: translateY(1px); }
      
      /* Noise Texture Overlay */
      body::after {
        content: "";
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        opacity: 0.03;
        pointer-events: none;
        z-index: 9999;
      }

      .experience-list {
        max-height: 350px;
        overflow-y: auto;
        list-style: none;
        padding: 0;
      }

      .experience-item {
        padding: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        transition: background 0.2s;
      }

      .experience-item:hover {
        background: rgba(255, 255, 255, 0.02);
      }

      .badge {
        background: var(--accent-color);
        color: black;
        padding: 2px 8px;
        border-radius: 4px;
        font-weight: bold;
        margin-right: 10px;
        font-size: 0.7rem;
        display: inline-block;
      }

      .lesson {
        display: block;
        color: var(--text-dim);
        margin-top: 8px;
        font-size: var(--font-small);
        border-top: 1px solid rgba(255, 255, 255, 0.05);
        padding-top: 8px;
        white-space: pre-line;
        line-height: 1.6;
      }

      .thinking-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(111, 66, 193, 0.2);
        border-top: 2px solid var(--accent-purple);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      h1 {
        font-family: 'Orbitron', sans-serif;
        letter-spacing: -1px;
        color: var(--text-main);
        background: linear-gradient(to right, #fff, var(--accent-color));
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin: 0;
        font-size: var(--font-h1);
        font-weight: 700;
      }

      /* å½ˆçª— */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0; top: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        overflow-y: auto;
      }

      .modal-content {
        background: #0a0a0a;
        margin: 4vh auto;
        padding: 40px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        width: 85%;
        max-width: 900px;
        border-radius: 32px;
        box-shadow: 0 40px 100px rgba(0, 0, 0, 0.8), 0 0 40px rgba(0, 242, 255, 0.05);
      }

      /* Progress Bar */
      .progress-container {
        width: 100%;
        height: 6px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 100px;
        margin-bottom: 40px;
        grid-column: span 2;
        overflow: hidden;
        display: none;
        position: relative;
      }
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--accent-color), var(--accent-purple));
        box-shadow: 0 0 10px var(--accent-color);
        width: 0%;
        transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .progress-label {
        position: absolute;
        right: 0;
        top: -18px;
        font-size: 0.65rem;
        color: var(--text-dim);
        font-family: 'Orbitron', sans-serif;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      /* Guided Tips Banner */
      .status-banner {
        width: 100%;
        max-width: 1200px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.05);
        padding: 20px 25px;
        border-radius: 20px;
        margin-bottom: 35px;
        display: flex;
        align-items: center;
        gap: 20px;
        animation: fadeIn 0.6s cubic-bezier(0.23, 1, 0.32, 1);
        box-sizing: border-box;
      }
      .status-icon {
        font-size: 1.6rem;
      }
      .status-title {
        font-weight: 700;
        color: var(--text-main);
        font-size: 0.95rem;
        margin-bottom: 4px;
        font-family: 'Orbitron', sans-serif;
      }
      .status-desc {
        font-size: 0.9rem;
        color: var(--text-dim);
        line-height: 1.5;
      }

      /* Responsive Adaptations */
      @media (max-width: 850px) {
        body { padding: 25px 20px; }
        .header { flex-direction: column; gap: 24px; text-align: center; }
        .header h1 { font-size: 1.6rem; }
        .trigger-btn { margin-left: 0; width: 100%; }
        .status-banner { padding: 15px; gap: 12px; }
      }

      @media (max-width: 480px) {
        .header h1 { font-size: 1.1rem; }
        .guide-btn { padding: 8px 12px; font-size: 0.75rem; }
        .trigger-btn { font-size: 0.9rem; padding: 10px 20px; }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div>
        <h1>
          AI BRAINSTORMING <span style="font-weight: 300; opacity: 0.6">WAR ROOM</span>
        </h1>
        <div style="margin-top: 10px; display: flex; align-items: center; gap: 15px;">
           <span id="aiModelBadge" style="font-size: 0.65rem; color: var(--accent-color); border: 1px solid rgba(0,242,255,0.3); padding: 2px 8px; border-radius: 4px; display: none; vertical-align: middle; font-family: 'Orbitron', sans-serif;">DETECTING HARDWARE...</span>
           <span id="currentSessionTopic" style="font-size: 0.85rem; color: var(--accent-color); font-weight: 600;">[STATUS: READY]</span>
        </div>
      </div>
      <div style="display: flex; gap: 12px;">
        <button class="guide-btn" onclick="openHelp()">æ“ä½œæ‰‹å†Š [HELP]</button>
        <button class="guide-btn" onclick="resetUI()" style="border-style: dashed; color: #ff6666; border-color: #ff6666;">å¼·åˆ·æ–° [RESET]</button>
      </div>
    </div>

    <div id="dynamicStatus" class="status-banner">
      <div class="status-icon">ğŸš€</div>
      <div class="status-text">
        <div class="status-title">ç³»çµ±å°å¼• (System Guide)</div>
        <div id="statusMessage" class="status-desc">æº–å‚™å°±ç·’ã€‚è«‹åœ¨ä¸‹æ–¹ [Master Console] è¼¸å…¥è­°é¡Œï¼Œæˆ–å¾å³å´é¸å–®è¼‰å…¥ã€Œæˆ°ç•¥åŠ‡æœ¬ã€ã€‚</div>
        <div id="statusCaution" class="caution-text">â€» æ³¨æ„ï¼šé–‹å§‹å‰è«‹ç¢ºèª AI åœ˜éšŠé…ç½®ç¬¦åˆè­°é¡Œéœ€æ±‚ã€‚</div>
      </div>
    </div>

    <div class="dashboard-container">
      <!-- ç³»çµ±æŒ‡æ®ä¸­å¿ƒ (System Command Center) -->
      <div class="card card-accent">
        <h2 style="color: var(--accent-color)">ç³»çµ±æŒ‡æ®ä¸­å¿ƒ (Command Center)</h2>
        <div style="display: flex; flex-direction: column; gap: 15px">
          <div>
            <label class="label-text">æ±ºç­–æ™ºæ…§é ˜åŸŸ (Strategic Workspace)</label>
            <select id="assetSwitcher" onchange="switchWorkspace(this.value)" style="width: 100%; border-color: var(--accent-color);">
              <option value="default">ğŸŒ æ ¸å¿ƒæˆ°ç•¥ (General Strategy)</option>
              <option value="product">ğŸ“¦ ç”¢å“ç ”ç™¼ (Product & Tech)</option>
              <option value="growth">ğŸ“ˆ å¸‚å ´æˆé•· (Market & Growth)</option>
              <option value="quality">ğŸ›¡ï¸ å“è³ªèˆ‡å”®å¾Œ (Quality & Service)</option>
            </select>
          </div>
          <div>
            <label class="label-text">åˆ†ææ¨¡å¼ (Analysis Mode)</label>
            <select id="analysisMode" style="width: 100%; border-color: var(--accent-purple);">
              <option value="default">ğŸ’¬ ä¸€èˆ¬å°è©± (Conversational)</option>
              <option value="swot">ğŸ“Š SWOT åˆ†æ (Structured)</option>
              <option value="pestel">ğŸŒ PESTEL åˆ†æ (Strategic)</option>
              <option value="antifragile">ğŸ›¡ï¸ æŠ—è„†å¼±åˆ†æ (Resilient)</option>
            </select>
          </div>
        </div>
      </div>

      <!-- ç³»çµ±æ™ºæ…§æ†²æ³• (System Constitution) -->
      <div class="card card-purple">
        <div style="display: flex; justify-content: space-between; align-items: start">
          <h2 style="color: var(--accent-purple)">ç³»çµ±æ™ºæ…§æ†²æ³• (Constitution)</h2>
          <span id="const-version" style="font-size: var(--font-tiny); color: var(--text-dim)">v0</span>
        </div>
        <div
          id="constitutionBox"
          style="font-size: var(--font-small); line-height: 1.6; color: var(--text-main); min-height: 80px; white-space: pre-line;"
        >
          å°šæœªé€²è¡Œæ™ºæ…§æç…‰...
        </div>
        <button
          id="evolveBtn"
          onclick="evolveSystem()"
          style="
            margin-top: 15px;
            width: 100%;
            background: rgba(168, 85, 247, 0.1);
            border: 1px solid var(--accent-purple);
            color: var(--text-main);
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: var(--font-small);
            font-family: 'Orbitron', sans-serif;
            transition: all 0.3s;
          "
        >
          é€²è¡Œæ™ºæ…§é€²åŒ– [EVOLVE]
        </button>
      </div>

      <!-- ä¸»ç†äººæ§åˆ¶å° (Master Console) -->
      <div class="card card-accent card-full">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
          <h2 style="color: var(--accent-color); margin: 0">ä¸»ç†äººæ§åˆ¶å° (Master Console)</h2>
          <div style="display: flex; gap: 10px; align-items: center;">
            <select id="scenarioSelector" onchange="loadScenario()" style="border-color: var(--accent-purple); color: var(--text-main); height: 45px;">
              <option value="">ğŸ“‚ è¼‰å…¥æˆ°ç•¥åŠ‡æœ¬ (Load Playbook)...</option>
              <optgroup label="ğŸ’¼ å•†æ¥­èˆ‡è·å ´ (Business & Career)">
                <option value="crisis">ğŸ”¥ ã€å±æ©Ÿå…¬é—œã€‘å“ç‰Œè²è­½ä¿®å¾©</option>
                <option value="launch">ğŸš€ ã€ç”¢å“ç™¼å¸ƒã€‘AI æ–°ç”¢å“ä¸Šå¸‚</option>
                <option value="reform">âš”ï¸ ã€çµ„ç¹”è®Šé©ã€‘ä¼æ¥­è½‰å‹èˆ‡è£å“¡</option>
                <option value="blue_ocean">ğŸŒŠ ã€è—æµ·ç­–ç•¥ã€‘å°‹æ‰¾æœªé–‹ç™¼å¸‚å ´</option>
                <option value="manage">ğŸ¤ ã€åœ˜éšŠç®¡ç†ã€‘è¡çªèª¿è§£èˆ‡æ¿€å‹µ</option>
                <option value="career">ğŸ“ ã€è·æ¶¯ç™¼å±•ã€‘ä¸­å¹´è½‰è·èˆ‡å‡é·</option>
                <option value="negotiate">ğŸ™ï¸ ã€æºé€šè«‡åˆ¤ã€‘é«˜é¢¨éšªå•†å‹™è«‡åˆ¤</option>
              </optgroup>
              <optgroup label="ğŸŒ± ç”Ÿæ´»èˆ‡æˆé•· (Life & Self-Growth)">
                <option value="learning">ğŸ§  ã€å­¸ç¿’æˆé•·ã€‘è·¨é ˜åŸŸæŠ€èƒ½é€Ÿæˆ</option>
                <option value="finance">ğŸ’° ã€è²¡å‹™è‡ªç”±ã€‘é€€ä¼‘è³‡ç”¢é…ç½®</option>
                <option value="health">ğŸ’ª ã€å¥åº·ç”Ÿæ´»ã€‘æ¸›é‡èˆ‡é«”èƒ½å„ªåŒ–</option>
                <option value="travel">âœˆï¸ ã€å®¶åº­æ—…éŠã€‘è¤‡é›œè¡Œç¨‹è¦åŠƒ</option>
              </optgroup>
              <optgroup label="ğŸ›¡ï¸ å“è³ªç®¡ç†å°ˆæ¬„ (Quality & Service)">
                <option value="complaint">ğŸš© ã€å®¢è¨´è§£æ±ºã€‘é«˜é¢¨éšªå“è³ªçˆ­è­°è™•ç†</option>
                <option value="quality_opt">ğŸ› ï¸ ã€ç³»çµ±å„ªåŒ–ã€‘å“è³ªç®¡æ§é«”ç³»å…¨é¢æå‡</option>
              </optgroup>
            </select>
            <button id="startSessionBtn" class="trigger-btn" onclick="startBrainstorm()">
              é–‹å•Ÿè…¦åŠ›æ¿€ç›ª [GO]
            </button>
          </div>
        </div>

        <div class="grid-half">
          <div>
            <label class="label-text">é‡å°è­°é¡Œç›®æ¨™ (Session Goal / Directive)</label>
            <input type="text" id="sessionTopic" placeholder="è­°é¡Œä¸»é¡Œï¼Œä¾‹å¦‚: å“ç‰Œè½‰å‹ç­–ç•¥" style="width: 100%; margin-bottom: 12px; border-color: var(--accent-color);">
            <textarea id="sessionContext" placeholder="è¨è«–ç›®æ¨™æˆ–è£œå……èƒŒæ™¯... (éš¨æ™‚ä¿®æ”¹ä¸¦æŒ‰ä¸‹æ–¹æ›´æ–°)" style="width: 100%; height: 100px;"></textarea>
          </div>
          <div style="display: flex; flex-direction: column; justify-content: flex-start; gap: 15px; padding-top: 25px;">
            <button
              id="updateGoalBtn"
              onclick="updateSessionGoal()"
              disabled
              style="
                background: rgba(255, 255, 255, 0.03);
                color: var(--text-dim);
                border: 1px solid #222;
                padding: 15px;
                border-radius: 8px;
                cursor: pointer;
                font-size: var(--font-small);
                transition: all 0.3s;
                font-family: 'Orbitron', sans-serif;
              "
            >
              æ›´æ–°ç•¶å‰è­°é¡Œ [UPDATE GOAL]
            </button>
            <div style="font-size: var(--font-tiny); color: var(--text-dim); line-height: 1.5; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; border-left: 3px solid var(--accent-color);">
              â€» æŒ‡ä»¤å°å¼•ï¼šæœƒè­°ä¸­ä¿®æ”¹å·¦å´æè¿°å¾ŒæŒ‰ä¸Šæ–¹æŒ‰éˆ•ï¼Œå³æ™‚æ”¹è®Š AI å°ˆå®¶çš„å°ç­–æ–¹å‘ã€‚
            </div>
          </div>
        </div>
      </div>

      <!-- åœ˜éšŠé…ç½®çª— (Team Roster) -->
      <div class="card card-full">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
          "
        >
          <h2>AI æˆ°ç•¥åœ˜éšŠé…ç½® (Team Roster)</h2>
          <button
            onclick="addTeamMember()"
            style="
              background: var(--accent-purple);
              color: white;
              border: none;
              padding: 5px 15px;
              border-radius: 5px;
              cursor: pointer;
              font-size: 0.8rem;
            "
          >
            + æ–°å¢ AI æˆå“¡
          </button>
        </div>
        <div id="teamContainer" style="display: flex; flex-wrap: wrap; gap: 15px">
          <!-- Team cards injected here -->
        </div>
      </div>

      <!-- æ±ºç­–é€²åº¦æ¢ (Consensus Progress) -->
      <div id="progressContainer" class="progress-container">
        <div id="progressLabel" class="progress-label">FLYWHEEL MOMENTUM: 0%</div>
        <div id="progressFill" class="progress-fill"></div>
      </div>

      <!-- å³æ™‚å‹•æ…‹è¦–çª—å€ (Dynamic Live Windows) -->
      <div
        id="brainstormField"
        class="card-full"
        style="
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
          gap: 20px;
          margin-bottom: 30px;
        "
      >
        <!-- AI opinion boxes injected here -->
      </div>

      <!-- é¦–å¸­æˆ°ç•¥å®˜ç¸½çµ (Synthesis & Action Plan) -->
      <div
        id="summarySection"
        class="card card-full"
        style="
          display: none;
          border: 2px solid var(--accent-purple);
          background: rgba(111, 66, 193, 0.05);
        "
      >
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h2 style="color: var(--accent-purple); margin: 0">
            ğŸ¯ é¦–å¸­æˆ°ç•¥å®˜ï¼šå…¨æ¡ˆæ•´åˆæ±ºè­° (Action Plan)
          </h2>
          <div id="summarySpinner" class="thinking-spinner"></div>
        </div>
        <div
          id="summaryBox"
          style="
            font-size: 1rem;
            line-height: 1.8;
            color: #eee;
            white-space: pre-wrap;
            padding: 20px;
            background: #000;
            border-radius: 10px;
            border: 1px solid #333;
          "
        >
          æ­£åœ¨ç­‰å¾…åœ˜éšŠåˆæ­¥è¨è«–...
        </div>
      </div>

      <!-- æœƒè­°ç´€éŒ„ (Session Logs) -->
      <div class="card card-full">
        <h2>æ­·å²æœƒè­°ç²¾è¯ (Past Session Insights)</h2>
        <ul id="experienceList" class="experience-list">
          <!-- Session results injected here -->
        </ul>
      </div>
    </div>

    <!-- æŒ‡å—å½ˆçª— (Help Modal) -->
    <div id="guideModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeGuide()">&times;</span>
        <div id="guideContent" class="guide-body">
          <h2>AI æˆ°ç•¥å¤§è…¦æœƒè­°å®¤ ä½¿ç”¨æŒ‡å—</h2>
          <p>
            æ­¡è¿ä¾†åˆ° AI é›†é«”æ±ºç­–å¹³å°ã€‚åœ¨é€™è£¡ï¼Œæ‚¨æ˜¯æœ€é«˜ä¸»ç†äººï¼ˆMasterï¼‰ï¼Œè² è²¬è¨­å®šè­°é¡Œä¸¦æŒ‡å°æ‚¨çš„ AI
            å°ˆå®¶åœ˜éšŠã€‚
          </p>
          <ul>
            <li><strong>å¤šè¼ªè¨è«–æ¨¡å¼</strong> - AI åœ˜éšŠæœƒæŒçºŒé€²è¡Œå¤šè¼ªè¾¯è«–èˆ‡å°è«‡ï¼Œç›´åˆ°é”æˆå…±è­˜ã€‚</li>
            <li><strong>åˆ†ææ¨¡å¼</strong> - é¸æ“‡ SWOT æˆ– PESTEL è®“ AI ä½¿ç”¨çµæ§‹åŒ–æ¡†æ¶æ€è€ƒã€‚</li>
            <li><strong>æˆ°ç•¥åŠ‡æœ¬</strong> - ä½¿ç”¨ä¸‹æ‹‰é¸å–®è¼‰å…¥ç¶“å…¸å•†æ¥­å ´æ™¯ï¼Œå¿«é€Ÿå•Ÿå‹•é«˜å“è³ªè¨è«–ã€‚</li>
            <li>
              <strong>æ™ºæ…§é€²åŒ–</strong> - æœƒè­°å¾Œé»æ“Š [EVOLVE] å¯å°‡ç¶“é©—æç…‰ç‚ºç³»çµ±çš„ã€Œæ†²æ³•åŸå‰‡ã€ã€‚
            </li>
          </ul>
        </div>
      </div>
    </div>

    <!-- å…¨åŠŸèƒ½å°è¦½å½ˆçª— (Full Guide Modal) -->
    <div id="fullGuideModal" class="modal">
      <div class="modal-content" style="max-width: 900px;">
        <span class="close" onclick="closeFullGuide()">&times;</span>
        <div class="guide-body">
          <h1 style="color: var(--accent-color); font-family: 'Orbitron', sans-serif; text-align: center; border: none;">æˆ°ç•¥å¤§è…¦æœƒè­°å®¤ï¼šå…¨åŠŸèƒ½èˆ‡æœ€ä½³å¯¦è¸</h1>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px;">
            <div>
              <h2 style="border-left: 4px solid var(--accent-color); padding-left: 10px;">ğŸ¯ æ ¸å¿ƒåŠŸèƒ½ (Core Features)</h2>
              <ul style="font-size: 0.9rem;">
                <li><strong>å¤šä»£ç†åšå¼ˆå…§é–£</strong>ï¼šæ¨¡æ“¬ä¸åŒéƒ¨é–€ä¸»ç®¡çš„åˆ©ç›Šè¡çªèˆ‡å…±è­˜é”æˆã€‚</li>
                <li><strong>çµæ§‹åŒ–åˆ†æå¼•æ“</strong>ï¼šå…§å»º SWOTã€PESTEL èˆ‡æŠ—è„†å¼±é¢¨éšªè©•ä¼°æ¡†æ¶ã€‚</li>
                <li><strong>SSE å¯¦æ™‚ä¸²æµ</strong>ï¼šå³æ™‚è§€å¯Ÿ AI æ€è€ƒéç¨‹ï¼Œå¦‚åŒçœŸå¯¦æœƒè­°ã€‚</li>
                <li><strong>æ™ºæ…§æç…‰ (Flywheel)</strong>ï¼šå°‡ç¢ç‰‡åŒ–å°è©±æ˜‡è¯ç‚ºæ°¸çºŒçš„ç³»çµ±æ†²æ³•ã€‚</li>
              </ul>
            </div>
            <div>
              <h2 style="border-left: 4px solid var(--accent-purple); padding-left: 10px;">ğŸŒŸ å°ˆæ¡ˆç”¨é€” (Purposes)</h2>
              <ul style="font-size: 0.9rem;">
                <li><strong>å£“åŠ›æ¸¬è©¦</strong>ï¼šåœ¨å¯¦éš›åŸ·è¡Œå‰ï¼Œè®“ AI åœ˜éšŠæ¨¡æ“¬å¯èƒ½çš„åå°æ„è¦‹èˆ‡é¢¨éšªã€‚</li>
                <li><strong>å‰µæ„ç™¼æ•£</strong>ï¼šé€éè·¨é ˜åŸŸ AI å°ˆå®¶çš„å°è©±ï¼Œæ‰“ç ´æ€è€ƒç›²é»ã€‚</li>
                <li><strong>æ±ºç­–è¨˜éŒ„</strong>ï¼šè‡ªå‹•ç”Ÿæˆ Markdown æ ¼å¼çš„æ­£å¼æœƒè­°ç´€éŒ„ã€‚</li>
                <li><strong>çŸ¥è­˜å‚³æ‰¿</strong>ï¼šé€éæ†²æ³•æ©Ÿåˆ¶ï¼Œè®“ç³»çµ±è¶Šç”¨è¶Šè°æ˜ã€‚</li>
              </ul>
            </div>
          </div>

          <h2 style="text-align: center; margin-top: 40px; color: var(--accent-color); border: none;">ğŸ’¡ æœ€ä½³ä½¿ç”¨æ–¹æ³• (Best Practices)</h2>
          <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px;">
            <ol>
              <li><strong>ç²¾ç¢ºè¨­è¨ˆåœ˜éšŠ</strong>ï¼šé‡å°è²¡å‹™è­°é¡Œè«‹åŠ å…¥ã€Œè²¡å‹™åˆ†æå¸«ã€ï¼ŒæŠ€è¡“è­°é¡Œè«‹åŠ å…¥ã€ŒCTOã€ã€‚</li>
              <li><strong>å‹•æ…‹å¼•å°ç›®æ¨™</strong>ï¼šåœ¨å°è©±éç¨‹ä¸­ï¼Œè‹¥ç™¼ç¾ AI åé›¢é‡é»ï¼Œæ‡‰åŠæ™‚ä¿®æ”¹ [è¨è«–ç›®æ¨™] ä¸¦é»æ“Š [UPDATE]ã€‚</li>
              <li><strong>å¼·åˆ¶åæ´¾è§’è‰²</strong>ï¼šåœ¨è§’è‰²è¨­å®šä¸­åŠ å…¥ã€Œé­”é¬¼ä»£è¨€äººã€ï¼Œèƒ½å¤§å¹…æå‡æ–¹æ¡ˆçš„æŠ—è„†å¼±æ€§ã€‚</li>
              <li><strong>å®šæœŸæ™ºæ…§é€²åŒ–</strong>ï¼šç´¯ç© 3-5 å ´é«˜å“è³ªæœƒè­°å¾Œï¼Œå‹™å¿…åŸ·è¡Œ [EVOLVE] ä»¥å„ªåŒ–ç³»çµ±åº•å±¤é‚è¼¯ã€‚</li>
            </ol>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentTeam = [
        {
          id: 'ai-mold',
          name: 'æ¨¡å…·å·¥ç¨‹éƒ¨ä¸»ç®¡',
          role: 'è² è²¬æ¨¡å…·è¨­è¨ˆå¯©æŸ¥ã€é–‹æ¨¡å¯è¡Œæ€§è©•ä¼°èˆ‡æŠ€è¡“å•é¡Œè§£æ±º',
          color: '#ff9900',
        },
        {
          id: 'ai-qa',
          name: 'å“ä¿éƒ¨ä¸»ç®¡',
          role: 'å°ˆæ³¨æ–¼é¢¨éšªç®¡æ§ã€å“è³ªæ¨™æº–ã€è‰¯ç‡æ§åˆ¶èˆ‡å®¢è¨´é é˜²',
          color: '#00f2ff',
        },
        {
          id: 'ai-sales',
          name: 'æ¥­å‹™éƒ¨ä¸»ç®¡',
          role: 'è² è²¬å®¢æˆ¶éœ€æ±‚é‡æ¸…ã€è¨‚å–®äº¤æœŸå”èª¿èˆ‡å¸‚å ´åé¥‹',
          color: '#00ff00',
        },
      ];
      let currentSessionId = null;
      let currentWorkspace = 'default';

      const SCENARIOS = {
        crisis: {
          topic: 'æ‡‰å°é‡å¤§å“ç‰Œå…¬é—œå±æ©Ÿ',
          context:
            'èƒŒæ™¯ï¼šå…¬å¸æ ¸å¿ƒç”¢å“è¢«çˆ†å‡ºå­˜åœ¨å®‰å…¨éš±æ‚£ï¼Œç¤¾äº¤åª’é«”ä¸Šè² é¢è¼¿è«–æ­£åœ¨ç™¼é…µï¼Œè‚¡åƒ¹ä¸‹è·Œ 5%ã€‚\nç›®æ¨™ï¼šåˆ¶å®šç·Šæ€¥å…¬é—œå›æ‡‰ç­–ç•¥ï¼Œä¸¦åœ¨ 24 å°æ™‚å…§æ§åˆ¶æå®³ï¼Œæ¢å¾©å…¬çœ¾ä¿¡ä»»ã€‚',
        },
        launch: {
          topic: 'AI å‰µæ–°ç”¢å“ä¸Šå¸‚ç™¼å¸ƒç­–ç•¥',
          context:
            'èƒŒæ™¯ï¼šæˆ‘å€‘é–‹ç™¼äº†ä¸€æ¬¾é©å‘½æ€§çš„å€‹äºº AI åŠ©ç†ï¼Œæº–å‚™åœ¨ä¸‹å€‹æœˆ CES å¤§å±•ä¸Šç™¼å¸ƒã€‚\nç›®æ¨™ï¼šè¨­è¨ˆä¸€å¥—èƒ½å¼•çˆ†å¸‚å ´è©±é¡Œçš„è¡ŒéŠ·æ¼æ–—ï¼Œç›®æ¨™æ˜¯åœ¨ç™¼å¸ƒé¦–æ—¥ç²å¾— 10 è¬è¨»å†Šç”¨æˆ¶ã€‚',
        },
        reform: {
          topic: 'ä¼æ¥­çµ„ç¹”é‡çµ„èˆ‡è£å“¡è¨ˆç•«',
          context:
            'èƒŒæ™¯ï¼šç”±æ–¼å¸‚å ´ç’°å¢ƒæƒ¡åŒ–ï¼Œå…¬å¸ç‡Ÿæ”¶ä¸‹æ»‘ 20%ï¼Œå¿…é ˆå‰Šæ¸›æˆæœ¬ä¸¦ç²¾ç°¡çµ„ç¹”çµæ§‹ã€‚\nç›®æ¨™ï¼šå¦‚ä½•åœ¨è£å“¡ 15% çš„åŒæ™‚ï¼Œç¶­æŒæ ¸å¿ƒäººæ‰çš„å£«æ°£ï¼Œä¸¦å®Œæˆå‘ã€Œæ•æ·é–‹ç™¼ã€æ¨¡å¼çš„è½‰å‹ï¼Ÿ',
        },
        blue_ocean: {
          topic: 'å°‹æ‰¾å¾Œç–«æƒ…æ™‚ä»£çš„è—æµ·å¸‚å ´',
          context:
            'èƒŒæ™¯ï¼šå‚³çµ±æ—…éŠæ¥­å¾©ç”¦ç·©æ…¢ï¼Œä½†æ•¸ä½éŠç‰§æ°‘æ— (Digital Nomads) ç¾¤é«”æ­£åœ¨å¿«é€Ÿå¢é•·ã€‚\nç›®æ¨™ï¼šæ§‹æ€ä¸€å€‹é‡å°æ­¤æ–°èˆˆç¾¤é«”çš„æœå‹™ç”Ÿæ…‹ç³»ï¼Œé¿é–‹ç´…æµ·ç«¶çˆ­ã€‚',
        },
        career: {
          topic: 'ä¸­å¹´è·æ¶¯è½‰å‹èˆ‡å‡é·ç­–ç•¥',
          context:
            'èƒŒæ™¯ï¼š40 æ­²ä¸­éšä¸»ç®¡ï¼Œé¢è‡¨è¡Œæ¥­å¤©èŠ±æ¿èˆ‡å¹´è¼•ä¸–ä»£ç«¶çˆ­ï¼ŒçŒ¶è±«æ˜¯å¦è©²è·³æ§½è‡³æ–°èˆˆ AI ç”¢æ¥­ã€‚\nç›®æ¨™ï¼šåˆ†æè½‰è·é¢¨éšªèˆ‡æ©Ÿæœƒï¼Œä¸¦è¦åŠƒæœªä¾† 5 å¹´çš„è·æ¶¯è·¯å¾‘èˆ‡å€‹äººå“ç‰Œé‡å¡‘ã€‚',
        },
        manage: {
          topic: 'åœ˜éšŠä¸–ä»£è¡çªèª¿è§£èˆ‡æ¿€å‹µ',
          context:
            'èƒŒæ™¯ï¼šåœ˜éšŠä¸­è³‡æ·±å“¡å·¥ (Gen X) èˆ‡æ–°é€²å“¡å·¥ (Gen Z) å› å·¥ä½œåƒ¹å€¼è§€ä¸åŒç”¢ç”Ÿæ‘©æ“¦ï¼Œå°è‡´å°ˆæ¡ˆé€²åº¦è½å¾Œã€‚\nç›®æ¨™ï¼šåˆ¶å®šä¸€å¥—èƒ½èåˆä¸åŒä¸–ä»£å„ªå‹¢çš„ç®¡ç†æ©Ÿåˆ¶ï¼Œä¸¦è¨­è¨ˆèƒ½åŒæ™‚æ¿€å‹µé›™æ–¹çš„çé…¬åˆ¶åº¦ã€‚',
        },
        negotiate: {
          topic: 'é«˜é¢¨éšªå•†å‹™è«‡åˆ¤æ¨¡æ“¬',
          context:
            'èƒŒæ™¯ï¼šå³å°‡èˆ‡é—œéµä¾›æ‡‰å•†é€²è¡Œå¹´åº¦åˆç´„è«‡åˆ¤ï¼Œå°æ–¹æš—ç¤ºå°‡æ¼²åƒ¹ 15%ï¼Œä½†æˆ‘æ–¹é ç®—å·²å‡çµã€‚\nç›®æ¨™ï¼šæ²™ç›¤æ¨æ¼”è«‡åˆ¤ç­–ç•¥ï¼Œæ‰¾å‡ºé›™è´çš„ç±Œç¢¼äº¤æ›é»ï¼Œç¢ºä¿æˆæœ¬æ§åˆ¶åœ¨ 5% æ¼²å¹…å…§ã€‚',
        },
        learning: {
          topic: 'è·¨é ˜åŸŸæŠ€èƒ½ 30 å¤©é€Ÿæˆè¨ˆç•«',
          context:
            'èƒŒæ™¯ï¼šéæŠ€è¡“èƒŒæ™¯çš„è¡ŒéŠ·äººå“¡ï¼Œæ€¥éœ€å­¸æœƒä½¿ç”¨ Python é€²è¡Œæ•¸æ“šåˆ†æä»¥æå‡å·¥ä½œæ•ˆç‡ã€‚\nç›®æ¨™ï¼šé‡èº«æ‰“é€ ä¸€ä»½é«˜å¼·åº¦çš„ 30 å¤©å­¸ç¿’èª²è¡¨ï¼ŒåŒ…å«å­¸ç¿’è³‡æºã€å¯¦ä½œå°ˆæ¡ˆèˆ‡æª¢æ ¸é»ã€‚',
        },
        finance: {
          topic: 'é‚å‘è²¡å‹™è‡ªç”±çš„è³‡ç”¢é…ç½®',
          context:
            'èƒŒæ™¯ï¼šé›™è–ªå®¶åº­ï¼Œå¹´æ”¶å…¥ç©©å®šä½†æ”¯å‡ºé«˜ï¼Œå¸Œæœ›åœ¨ 15 å¹´å¾Œé”æˆ FIRE (è²¡å‹™ç¨ç«‹ï¼Œææ—©é€€ä¼‘)ã€‚\nç›®æ¨™ï¼šæª¢è¦–ç›®å‰è²¡å‹™æ¼æ´ï¼Œä¸¦å»ºè­°é©åˆç•¶å‰ç¶“æ¿Ÿå±€å‹¢çš„è³‡ç”¢é…ç½®çµ„åˆï¼ˆè‚¡å‚µæˆ¿å¹£ï¼‰ã€‚',
        },
        health: {
          topic: 'å¿™ç¢Œå°ˆæ¥­äººå£«çš„é«”èƒ½å„ªåŒ–',
          context:
            'èƒŒæ™¯ï¼šé«˜å£“å·¥ä½œè€…ï¼Œé•·æœŸä¹…åã€ç¡çœ ä¸è¶³ä¸”é«”è„‚éé«˜ï¼Œæ²’æ™‚é–“å»å¥èº«æˆ¿ã€‚\nç›®æ¨™ï¼šè¨­è¨ˆä¸€å¥—ã€Œæ¥µç°¡ã€ä½†é«˜æ•ˆçš„é£²é£Ÿèˆ‡å±…å®¶è¨“ç·´æ–¹æ¡ˆï¼Œç›®æ¨™æ˜¯ 3 å€‹æœˆå…§é«”è„‚é™ 5%ã€‚',
        },
        travel: {
          topic: 'ä¸‰ä»£åŒå ‚çš„å®Œç¾å®¶æ—æ—…éŠ',
          context:
            'èƒŒæ™¯ï¼šè¨ˆç•«å¸¶ 70 æ­²çˆ¶æ¯èˆ‡ 5 æ­²å°å­©å»æ—¥æœ¬æ—…éŠ 7 å¤©ï¼Œéœ€è€ƒé‡é«”åŠ›è½å·®èˆ‡é£²é£Ÿåå¥½ã€‚\nç›®æ¨™ï¼šè¦åŠƒä¸€ä»½è®“è€å°‘ç›¡æ­¡çš„è©³ç´°è¡Œç¨‹è¡¨ï¼ŒåŒ…å«äº¤é€šå‹•ç·šã€ä¼‘æ¯é»èˆ‡ç·Šæ€¥å‚™æ¡ˆæ ¼å¼ã€‚',
        },
        complaint: {
          topic: 'å®¢è¨´å•é¡Œè§£æ±ºï¼šé«˜é¢¨éšªå“è³ªçˆ­è­°è™•ç†',
          context:
            'èƒŒæ™¯ï¼šå®¢æˆ¶åæ˜ è¿‘æœŸæ‰¹æ¬¡ç”¢å“å‡ºç¾åŠŸèƒ½æ€§ç¼ºé™·ï¼Œå·²é€ æˆå…¶ç”¢ç·šåœå·¥ï¼Œè¦æ±‚æˆ‘æ–¹åœ¨ 48 å°æ™‚å…§çµ¦å‡ºé‘‘å®šå ±å‘Šèˆ‡è£œå„Ÿæ–¹æ¡ˆã€‚\nç›®æ¨™ï¼š1. è¿…é€Ÿåˆ¤å®šçœŸå›  (Root Cause)ã€‚ 2. åˆ¶å®šé˜²å µã€åœå µèˆ‡é•·æœŸå°ç­–ã€‚ 3. æ“¬å®šå®¢æˆ¶æºé€šè©±è¡“ï¼Œé™ä½å“ç‰Œä¿¡è­½æå¤±ã€‚',
        },
        quality_opt: {
          topic: 'å“è³ªç³»çµ±å„ªåŒ–ï¼šç®¡æ§é«”ç³»å…¨é¢æå‡',
          context:
            'èƒŒæ™¯ï¼šå…§éƒ¨è‰¯ç‡å‡ºç¾æ³¢å‹•ï¼Œä¸”ç¾æœ‰æª¢æ¸¬æµç¨‹éæ–¼ä¾è³´äººå·¥ï¼Œæ¼æª¢é¢¨éšªé«˜ã€‚\nç›®æ¨™ï¼š1. è¨ºæ–·ç¾æœ‰å“è³ªé«”ç³» (QMS) çš„çµæ§‹æ€§æ¼æ´ã€‚ 2. å°å…¥è‡ªå‹•åŒ–æª¢æ¸¬æˆ– AI è¦–è¦ºæª¢é©—çš„å¯è¡Œæ€§åˆ†æã€‚ 3. é‡æ–°ä¿®æ­£ä½œæ¥­æ¨™æº–æ›¸ (SOP)ï¼Œè½å¯¦æºé ­ç®¡ç†ã€‚',
        },
      };

      function loadScenario() {
        const key = document.getElementById('scenarioSelector').value;
        if (SCENARIOS[key]) {
          document.getElementById('sessionTopic').value = SCENARIOS[key].topic;
          document.getElementById('sessionContext').value = SCENARIOS[key].context;
        }
      }

      async function init() {
        renderTeam(); // ç«‹å³æ¸²æŸ“é è¨­è§’è‰²
        await loadTeam();
        await loadHistory();
        await loadConstitution();
      }

      async function loadConstitution() {
        try {
          const res = await fetch(`/api/constitution?assetId=${currentWorkspace}`);
          const data = await res.json();
          const box = document.getElementById('constitutionBox');
          const ver = document.getElementById('const-version');
          if (data && data.principles) {
            box.innerText = data.principles;
            ver.innerText = `v${data.version}`;
          }
        } catch (err) {
          console.warn('Constitution not available locally.');
        }
      }

      async function evolveSystem() {
        const btn = document.getElementById('evolveBtn');
        const box = document.getElementById('constitutionBox');
        btn.disabled = true;
        btn.innerText = 'æ™ºæ…§æç…‰ä¸­ [EVOLVING...]';
        box.style.opacity = '0.5';

        try {
          const res = await fetch('/api/distill', { 
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ assetId: currentWorkspace })
          });
          const data = await res.json();
          if (data.success) {
            await loadConstitution();
            alert('ç³»çµ±æ†²æ³•é€²åŒ–å®Œæˆï¼å…ƒæ™ºæ…§å·²æ›´æ–°ã€‚');
          } else {
            alert('æ™ºæ…§ä¸è¶³ï¼š' + (data.error || 'éœ€è¦æ›´å¤šæœƒè­°ç¶“é©—æ‰èƒ½æç…‰ã€‚'));
          }
        } catch (err) {
          alert('ç„¡æ³•é€£ç·šåˆ°æ™ºæ…§å…§é–£');
        } finally {
          btn.disabled = false;
          btn.innerText = 'é€²è¡Œæ™ºæ…§é€²åŒ– [EVOLVE]';
          box.style.opacity = '1';
        }
      }

      async function loadTeam() {
        try {
          const res = await fetch('/api/team');
          if (!res.ok) throw new Error(`API returned ${res.status}`);
          
          const contentType = res.headers.get("content-type");
          if (!contentType || !contentType.includes("application/json")) {
            throw new Error("API did not return JSON");
          }
          
          currentTeam = await res.json();
          renderTeam();
        } catch (err) {
          console.warn('Backend API not available (Normal on GitHub Pages), using default team.');
        }
      }

      function renderTeam() {
        const container = document.getElementById('teamContainer');
        if (!container) return;
        container.innerHTML = '';
        currentTeam.forEach((m, index) => {
          const card = document.createElement('div');
          card.className = 'card';
          card.style.flex = '1 1 250px';
          card.style.margin = '0';
          card.style.borderLeft = `4px solid ${m.color}`;
          card.innerHTML = `
                    <div style="display: flex; justify-content: space-between;">
                        <strong style="color: ${m.color}">${m.name}</strong>
                        <button onclick="removeMember(${index})" style="background: none; border: none; color: #666; cursor: pointer;">&times;</button>
                    </div>
                    <div style="font-size: 0.75rem; color: #aaa; margin-top: 5px;">${m.role}</div>
                `;
          container.appendChild(card);
        });
      }

      async function addTeamMember() {
        const name = prompt('AI å°ˆå®¶å§“å:');
        const role = prompt('å°ˆå®¶è·è²¬/å°ˆæ¥­é ˜åŸŸ:');
        if (!name || !role) return;

        const colors = ['#ff00ff', '#00f2ff', '#00ff00', '#ffcc00', '#ff4444'];
        currentTeam.push({
          id: 'ai-' + Date.now(),
          name,
          role,
          color: colors[currentTeam.length % colors.length],
        });
        await saveTeam();
      }

      async function removeMember(index) {
        currentTeam.splice(index, 1);
        await saveTeam();
      }

      async function saveTeam() {
        await fetch('/api/team', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ members: currentTeam }),
        });
        renderTeam();
      }

      async function startBrainstorm() {
        const topic = document.getElementById('sessionTopic').value;
        const context = document.getElementById('sessionContext').value;
        if (!topic) return alert('è«‹å…ˆè¼¸å…¥è¨è«–è­°é¡Œ');

        currentSessionId = 'session-' + Date.now();
        const field = document.getElementById('brainstormField');
        field.innerHTML = '';
        document.getElementById('summarySection').style.display = 'block';
        document.getElementById('summaryBox').innerText = 'æˆ°ç•¥è¨ˆç•«å•Ÿå‹•ä¸­...';
        document.getElementById('summarySpinner').style.display = 'block';

        currentTeam.forEach((m) => {
          const box = document.createElement('div');
          box.id = `box-${m.id}`;
          box.className = 'card';
          box.style.border = `1px solid ${m.color}`;
          box.style.background = 'rgba(0,0,0,0.8)';
          box.style.display = 'flex';
          box.style.flexDirection = 'column';
          box.style.maxHeight = '400px';
          box.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px;">
                        <span class="badge" style="background: ${m.color}; color: #000;">${m.name}</span>
                        <div id="spinner-${m.id}" class="thinking-spinner" style="display:none;"></div>
                    </div>
                    <div id="history-${m.id}" style="font-size: 0.85rem; line-height: 1.6; color: #888; overflow-y: auto;">ç­‰å¾…åŠ å…¥å°è©±...</div>
                `;
          field.appendChild(box);
        });

        const btn = document.getElementById('startSessionBtn');
        const updateBtn = document.getElementById('updateGoalBtn');
        const analysisMode = document.getElementById('analysisMode').value;
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressLabel = document.getElementById('progressLabel');

        btn.disabled = true;
        btn.innerText = 'æœƒè­°å‹•æ…‹é€²è¡Œä¸­...';
        updateBtn.disabled = false;
        updateBtn.style.background = 'var(--accent-color)';
        updateBtn.style.color = 'black';
        
        progressContainer.style.display = 'block';
        progressFill.style.width = '0%';
        progressLabel.innerText = 'FLYWHEEL MOMENTUM: 0%';

        // Update Guided Tip
        updateStatus('ğŸ¤”', 'æœƒè­°é€²è¡Œä¸­...', 'AI åœ˜éšŠæ­£åœ¨é‡å°è­°é¡Œé€²è¡Œå¤šè¼ªè¾¯è«–ã€‚æ‚¨å¯ä»¥è§€å¯Ÿä¸‹æ–¹å„å°ˆå®¶çš„å³æ™‚è¦‹è§£ã€‚', 'â€» æç¤ºï¼šæ‚¨å¯ä»¥éš¨æ™‚ä¿®æ”¹ã€Œè¨è«–ç›®æ¨™ã€ä¸¦é»æ“Š [UPDATE] ä¾†èª¿æ•´æœƒè­°èˆªå‘ã€‚');

        const url = `/api/brainstorm-stream?topic=${encodeURIComponent(
          topic
        )}&context=${encodeURIComponent(
          context
        )}&sessionId=${currentSessionId}&analysisMode=${analysisMode}&assetId=${currentWorkspace}`;
        const eventSource = new EventSource(url);

        eventSource.onmessage = (event) => {
          let data;
          try {
            data = JSON.parse(event.data);
          } catch (e) {
            console.error('Failed to parse SSE data:', e);
            return;
          }
          
          if (data.type === 'ROUND_START') {
            currentTeam.forEach((m) => {
               const spinner = document.getElementById(`spinner-${m.id}`);
               const card = spinner.closest('.card');
               if (spinner) spinner.style.display = 'block';
               if (card) card.classList.add('thinking-active');
            });
          } else if (data.type === 'THOUGHT' && data.memberId) {
            const histDiv = document.getElementById(`history-${data.memberId}`);
            const spinner = document.getElementById(`spinner-${data.memberId}`);
            const card = histDiv.closest('.card');
            
            const msg = document.createElement('div');
            msg.innerHTML = `<span style="color:var(--text-dim); font-size:0.7rem;">[Round ${data.round || ''}]</span><br>${data.message}`;
            msg.style.marginBottom = '10px';
            msg.style.color = 'white';
            msg.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
            msg.style.paddingBottom = '5px';
            histDiv.appendChild(msg);
            histDiv.scrollTop = histDiv.scrollHeight;
            
            if (spinner) spinner.style.display = 'none';
            if (card) card.classList.remove('thinking-active');
          } else if (data.type === 'THOUGHT') {
            document.getElementById('summaryBox').innerText = data.message;
            document.getElementById('summarySpinner').style.display = 'block';
          } else if (data.type === 'PROGRESS') {
            const val = data.progress || 0;
            document.getElementById('progressFill').style.width = val + '%';
            document.getElementById('progressLabel').innerText = `FLYWHEEL MOMENTUM: ${val}%`;
          } else if (data.type === 'CONSENSUS') {
            document.getElementById('progressFill').style.width = '100%';
            document.getElementById('progressLabel').innerText = `FLYWHEEL MOMENTUM: 100%`;
            document.getElementById('summaryBox').innerText = 'ã€å…±è­˜æª¢æ ¸ã€‘\n' + data.message + '\n\næ­£åœ¨ç”¢å‡ºå…¨æ¡ˆåŸ·è¡Œè¨ˆç•«...';
          } else if (data.type === 'SUMMARY') {
            document.getElementById('progressFill').style.width = '100%';
            document.getElementById('progressLabel').innerText = `FLYWHEEL MOMENTUM: 100%`;
            document.getElementById('summaryBox').innerText = data.message;
            document.getElementById('summarySpinner').style.display = 'none';
            updateStatus('ğŸ¯', 'è¨ˆç•«å·²ç”¢å‡º', 'é¦–å¸­æˆ°ç•¥å®˜å·²å®Œæˆå…¨æ¡ˆç¸½çµèˆ‡è¡Œå‹•æŒ‡å—ã€‚è«‹æŸ¥é–±ä¸‹æ–¹çš„ [Action Plan]ã€‚', 'â€» å»ºè­°ï¼šé»æ“Šå³å´çš„ [EVOLVE] å°‡æ­¤ç¶“é©—æç…‰ç‚ºç³»çµ±æ†²æ³•ï¼Œæˆ–é»æ“Š [RESET UI] é–‹å§‹æ–°è­°é¡Œã€‚');
          } else if (data.type === 'COMPLETE') {
            document.getElementById('progressFill').style.width = '100%';
            eventSource.close();
            btn.disabled = false;
            btn.innerText = 'é–‹å•Ÿæ–°è­°é¡Œè…¦æ¿€ [GO]';
            updateBtn.disabled = true;
            updateBtn.style.background = 'rgba(255,255,255,0.1)';
            updateBtn.style.color = '#888';
            loadHistory();
            // Final cleanup of pulses
            document.querySelectorAll('.card').forEach(c => c.classList.remove('thinking-active'));
          } else if (data.type === 'ERROR') {
            eventSource.close();
            alert(data.message);
            btn.disabled = false;
            document.getElementById('summarySpinner').style.display = 'none';
          }
        };

        eventSource.onerror = (err) => {
          console.error('SSE Connection Error:', err);
          eventSource.close();
          btn.disabled = false;
          btn.innerText = 'é€£ç·šä¸­æ–·ï¼Œè«‹é‡è©¦ [RETRY]';
          document.getElementById('summarySpinner').style.display = 'none';
          updateStatus('âš ï¸', 'é€£ç·šç•°å¸¸', 'èˆ‡ AI å…§é–£çš„é€£ç·šå·²ä¸­æ–·ã€‚å¯èƒ½æ˜¯ç¶²è·¯æ³¢å‹•æˆ–ä¼ºæœå™¨æ­£åœ¨é‡å•Ÿã€‚', 'â€» å»ºè­°ï¼šæª¢æŸ¥å¾Œç«¯æœå‹™ç‹€æ…‹å¾Œé»æ“Š RETRY é‡æ–°å•Ÿå‹•è­°é¡Œã€‚');
        };
      }

      async function updateSessionGoal() {
        const goal = document.getElementById('sessionContext').value;
        if (!currentSessionId) return;
        const res = await fetch('/api/brainstorm/goal', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId: currentSessionId, goal }),
        });
        const data = await res.json();
        if (data.success) {
          const updateBtn = document.getElementById('updateGoalBtn');
          const oldText = updateBtn.innerText;
          updateBtn.innerText = 'ç›®æ¨™å·²åŒæ­¥ï¼';
          setTimeout(() => (updateBtn.innerText = oldText), 2000);
        }
      }

      // Aliases and UI helpers
      function triggerTick() {
        startBrainstorm();
      }
      async function switchWorkspace(val) {
        currentWorkspace = val;
        console.log('Switching to Workspace:', currentWorkspace);
        
        // Visual feedback
        const box = document.getElementById('constitutionBox');
        const list = document.getElementById('experienceList');
        if (box) box.style.opacity = '0.3';
        if (list) list.style.opacity = '0.3';

        await Promise.all([loadConstitution(), loadHistory()]);

        setTimeout(() => {
          if (box) box.style.opacity = '1';
          if (list) list.style.opacity = '1';
        }, 300);

        updateStatus('ğŸŒ', 'é ˜åŸŸå·²åˆ‡æ›', `ç›®å‰å·²é€²å…¥ [${val}] æ±ºç­–é ˜åŸŸã€‚è©²é ˜åŸŸçš„æ­·å²ç´€éŒ„èˆ‡æ†²æ³•åŸå‰‡å·²è¼‰å…¥å®Œç•¢ã€‚`, 'â€» æ³¨æ„ï¼šä¸åŒé ˜åŸŸçš„ AI ç´¯ç©æ™ºæ…§ç›¸äº’ç¨ç«‹ã€‚');
      }

      function openHelp() {
        openFullGuide();
      }

      function resetUI() {
        location.reload();
      }

      async function loadSystemStatus() {
        try {
          const res = await fetch('/api/system/status');
          const data = await res.json();
          const badge = document.getElementById('aiModelBadge');
          if (badge) {
            const isCloud = data.tier === 'CLOUD';
            const icon = isCloud ? 'â˜ï¸' : 'ğŸ“¥';
            const glow = isCloud ? '0 0 10px rgba(189, 0, 255, 0.4)' : '0 0 10px rgba(0, 242, 255, 0.4)';
            
            badge.innerHTML = `<span style="margin-right:5px">${icon}</span> AI: ${data.activeModel.toUpperCase()} (${data.tier})`;
            badge.title = data.reason;
            badge.style.display = 'inline-block';
            badge.style.boxShadow = glow;
            if (isCloud) badge.style.borderColor = 'var(--accent-purple)';
          }
        } catch (e) {
          console.error('Failed to load system status');
        }
      }

      window.onload = async () => {
        await loadSystemStatus();
        await loadConstitution();
        await loadHistory();
      };

      async function loadHistory() {
        try {
          const res = await fetch(`/api/experience?assetId=${currentWorkspace}`);
          if (!res.ok) return; // Silent return for 404
          
          const contentType = res.headers.get("content-type");
          if (!contentType || !contentType.includes("application/json")) return;

          const exps = await res.json();
          const list = document.getElementById('experienceList');
          if (!list) return;
          list.innerHTML = '';
          exps
            .reverse()
            .slice(0, 10)
            .forEach((e) => {
              const li = document.createElement('li');
              li.className = 'experience-item';
              li.innerHTML = `
                        <div style="display: flex; justify-content: space-between;">
                            <strong>${e.decision || 'BRAINSTORM'}</strong>
                            <span style="font-size: 0.7rem; color: #555;">${new Date(e.created_at).toLocaleString()}</span>
                        </div>
                        <div class="lesson" style="margin-top: 10px; white-space: pre-wrap;">${e.lesson}</div>
                    `;
              list.appendChild(li);
            });
        } catch (err) {}
      }

      function openGuide() {
        document.getElementById('guideModal').style.display = 'block';
      }
      function closeGuide() {
        document.getElementById('guideModal').style.display = 'none';
      }
      function openFullGuide() {
        document.getElementById('fullGuideModal').style.display = 'block';
      }
      function closeFullGuide() {
        document.getElementById('fullGuideModal').style.display = 'none';
      }

      function updateStatus(icon, title, desc, caution) {
        document.getElementById('dynamicStatus').querySelector('.status-icon').innerText = icon;
        document.getElementById('statusMessage').previousElementSibling.innerText = `ç³»çµ±å°å¼• (${title})`;
        document.getElementById('statusMessage').innerText = desc;
        document.getElementById('statusCaution').innerText = caution || '';
      }

      init();
    </script>
  </body>
</html>
